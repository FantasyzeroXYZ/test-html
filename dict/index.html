<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yomitan多功能词典查询</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px 0;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        header p {
            font-size: 1.1rem;
            max-width: 700px;
            margin: 0 auto;
            opacity: 0.9;
        }
        
        .mode-selector {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        
        .mode-selector h2 {
            margin-bottom: 15px;
            color: #2575fc;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .mode-options {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .mode-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .mode-option:hover {
            background: #e9ecef;
        }
        
        .mode-option.active {
            background: #e7f1ff;
            border-color: #2575fc;
            color: #2575fc;
        }
        
        .mode-option input {
            margin: 0;
        }
        
        .search-container {
            display: flex;
            margin-bottom: 30px;
            gap: 15px;
        }
        
        .search-box {
            flex: 1;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 15px 20px 15px 50px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        
        .search-box input:focus {
            outline: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .search-box i {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        
        .search-options {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .option-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .option-group label {
            font-weight: 500;
        }
        
        .option-group select, .option-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        
        /* 结果区域 - 统一为一个方框 */
        .results-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        /* 标签页样式 */
        .tabs-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            height: 600px;
        }
        
        .primary-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
            padding: 0 15px;
            min-height: 50px;
        }
        
        .primary-tab {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        
        .primary-tab.active {
            border-bottom-color: #2575fc;
            color: #2575fc;
            background: white;
        }
        
        .secondary-tabs {
            display: flex;
            background: #f1f3f4;
            border-bottom: 1px solid #ddd;
            padding: 0 15px;
            flex-wrap: wrap;
            min-height: 40px;
        }
        
        .secondary-tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        .secondary-tab.active {
            border-bottom-color: #6a11cb;
            color: #6a11cb;
            background: white;
        }
        
        .tab-content {
            flex: 1;
            overflow: auto;
            padding: 20px;
            background: white;
        }
        
        .tab-pane {
            display: none;
            height: 100%;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        .web-content-frame {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .web-content-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
            text-align: center;
            padding: 20px;
        }
        
        .web-content-placeholder i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .term-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .term-item {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .term-item:hover {
            border-color: #2575fc;
            box-shadow: 0 2px 8px rgba(37, 117, 252, 0.1);
        }
        
        .term-heading {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .term-expression {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2575fc;
        }
        
        .term-reading {
            color: #6c757d;
            font-style: italic;
        }
        
        .term-pos {
            background: #e9ecef;
            color: #495057;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .term-definitions {
            margin-top: 10px;
        }
        
        .definition-list {
            padding-left: 20px;
        }
        
        .definition-item {
            margin-bottom: 5px;
        }
        
        .api-results {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .api-item {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .api-source {
            font-weight: bold;
            color: #495057;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .api-content {
            color: #333;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
            background: #f8d7da;
            border-radius: 8px;
        }
        
        .btn {
            padding: 12px 24px;
            background: #2575fc;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #1a68e8;
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            .search-container {
                flex-direction: column;
            }
            
            .search-options {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .term-heading {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .mode-options {
                flex-direction: column;
            }
            
            .primary-tabs, .secondary-tabs {
                flex-wrap: wrap;
            }
            
            .primary-tab, .secondary-tab {
                font-size: 0.85rem;
                padding: 10px 12px;
            }
            
            .tabs-container {
                height: 500px;
            }
            
            header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-search"></i> Yomitan多功能词典查询</h1>
            <p>集成词典查询、网页内容搜索和API查询的一站式解决方案</p>
        </header>
        
        <div class="mode-selector">
            <h2><i class="fas fa-cog"></i> 搜索模式选择</h2>
            <div class="mode-options">
                <label class="mode-option" id="modeDictionaryOption">
                    <input type="checkbox" id="modeDictionary" checked>
                    <i class="fas fa-book"></i>
                    <span>Yomitan词典</span>
                </label>
                <label class="mode-option" id="modeWebOption">
                    <input type="checkbox" id="modeWeb">
                    <i class="fas fa-globe"></i>
                    <span>网页内容</span>
                </label>
                <label class="mode-option" id="modeAPIOption">
                    <input type="checkbox" id="modeAPI">
                    <i class="fas fa-code"></i>
                    <span>API查询</span>
                </label>
                <label class="mode-option" id="modeTranslateOption">
                    <input type="checkbox" id="modeTranslate">
                    <i class="fas fa-language"></i>
                    <span>翻译</span>
                </label>
            </div>
        </div>
        
        <div class="search-container">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="输入要查询的内容...">
            </div>
            <button class="btn" id="searchBtn">搜索</button>
        </div>
        
        <div class="search-options">
            <div class="option-group">
                <label for="searchMode">搜索模式:</label>
                <select id="searchMode">
                    <option value="exact">精确匹配</option>
                    <option value="prefix">前缀匹配</option>
                    <option value="suffix">后缀匹配</option>
                    <option value="contains">包含匹配</option>
                </select>
            </div>
            <div class="option-group">
                <label for="maxResults">最大结果数:</label>
                <input type="number" id="maxResults" value="50" min="10" max="200">
            </div>
            <div class="option-group">
                <input type="checkbox" id="caseSensitive">
                <label for="caseSensitive">区分大小写</label>
            </div>
        </div>
        
        <!-- 统一的结果区域 -->
        <div class="results-container">
            <div class="tabs-container">
                <div class="primary-tabs" id="primaryTabs">
                    <!-- 一级标签页将根据选择的模式动态生成 -->
                </div>
                <div class="secondary-tabs" id="secondaryTabs">
                    <!-- 二级标签页将由油猴脚本动态生成 -->
                </div>
                <div class="tab-content" id="tabContent">
                    <!-- 标签页内容将动态生成 -->
                    <div class="web-content-placeholder">
                        <i class="fas fa-browser"></i>
                        <h4>多功能词典查询</h4>
                        <p>请选择搜索模式并输入搜索词开始查询</p>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Yomitan多功能词典查询页面 &copy; 2023 | 支持词典查询、网页内容搜索、API查询和翻译</p>
        </footer>
    </div>

    <script>
        // 全局变量存储词典数据
        let dictionaryData = {
            index: null,
            tagBanks: [],
            termBanks: []
        };

        // 当前激活的搜索模式
        let activeModes = {
            dictionary: true,
            web: false,
            api: false,
            translate: false
        };

        // 模式顺序记录
        let modeOrder = ['dictionary', 'web', 'api', 'translate'];

        // 标签页管理
        const tabManager = {
            primaryTabs: [],
            secondaryTabs: [],
            activePrimaryTab: null,
            activeSecondaryTab: null,
            
            // 初始化标签页
            init() {
                this.updatePrimaryTabs();
                this.setupTabEvents();
            },
            
            // 更新一级标签页
            updatePrimaryTabs() {
                const primaryTabsContainer = document.getElementById('primaryTabs');
                primaryTabsContainer.innerHTML = '';
                
                this.primaryTabs = [];
                
                // 根据激活的模式和顺序添加标签页
                modeOrder.forEach(modeId => {
                    if (activeModes[modeId]) {
                        this.addPrimaryTab(modeId);
                    }
                });
                
                // 设置默认激活的标签页
                if (this.primaryTabs.length > 0) {
                    this.setActivePrimaryTab(this.primaryTabs[0].id);
                }
            },
            
            // 添加一级标签页
            addPrimaryTab(modeId) {
                const primaryTabsContainer = document.getElementById('primaryTabs');
                
                let label, iconClass;
                switch(modeId) {
                    case 'dictionary':
                        label = 'Yomitan词典';
                        iconClass = 'fas fa-book';
                        break;
                    case 'web':
                        label = '网页内容';
                        iconClass = 'fas fa-globe';
                        break;
                    case 'api':
                        label = 'API查询';
                        iconClass = 'fas fa-code';
                        break;
                    case 'translate':
                        label = '翻译';
                        iconClass = 'fas fa-language';
                        break;
                }
                
                const tab = document.createElement('div');
                tab.className = 'primary-tab';
                tab.dataset.tabId = modeId;
                tab.innerHTML = `<i class="${iconClass}"></i> ${label}`;
                
                primaryTabsContainer.appendChild(tab);
                
                this.primaryTabs.push({
                    id: modeId,
                    label: label,
                    iconClass: iconClass,
                    element: tab
                });
                
                return tab;
            },
            
            // 设置激活的一级标签页
            setActivePrimaryTab(tabId) {
                // 移除所有标签页的激活状态
                this.primaryTabs.forEach(tab => {
                    tab.element.classList.remove('active');
                });
                
                // 设置当前标签页为激活状态
                const activeTab = this.primaryTabs.find(tab => tab.id === tabId);
                if (activeTab) {
                    activeTab.element.classList.add('active');
                    this.activePrimaryTab = activeTab;
                    
                    // 更新二级标签页
                    this.updateSecondaryTabs(tabId);
                }
            },
            
            // 更新二级标签页
            updateSecondaryTabs(primaryTabId) {
                const secondaryTabsContainer = document.getElementById('secondaryTabs');
                secondaryTabsContainer.innerHTML = '';
                
                this.secondaryTabs = [];
                
                // 根据一级标签页添加对应的二级标签页
                if (primaryTabId === 'web' || primaryTabId === 'translate') {
                    // 网页和翻译标签页的二级标签将由油猴脚本动态添加
                    // 这里可以添加一些默认的二级标签页
                    this.addSecondaryTab('default', '默认页面', true);
                } else {
                    // 其他标签页不需要二级标签
                    secondaryTabsContainer.style.display = 'none';
                    this.updateTabContent();
                    return;
                }
                
                secondaryTabsContainer.style.display = 'flex';
                
                // 设置默认激活的二级标签页
                if (this.secondaryTabs.length > 0) {
                    this.setActiveSecondaryTab(this.secondaryTabs[0].id);
                }
            },
            
            // 添加二级标签页
            addSecondaryTab(id, label, isActive = false) {
                const secondaryTabsContainer = document.getElementById('secondaryTabs');
                
                const tab = document.createElement('div');
                tab.className = 'secondary-tab';
                if (isActive) tab.classList.add('active');
                tab.dataset.tabId = id;
                tab.textContent = label;
                
                secondaryTabsContainer.appendChild(tab);
                
                this.secondaryTabs.push({
                    id: id,
                    label: label,
                    element: tab,
                    content: null
                });
                
                return tab;
            },
            
            // 设置激活的二级标签页
            setActiveSecondaryTab(tabId) {
                // 移除所有二级标签页的激活状态
                this.secondaryTabs.forEach(tab => {
                    tab.element.classList.remove('active');
                });
                
                // 设置当前二级标签页为激活状态
                const activeTab = this.secondaryTabs.find(tab => tab.id === tabId);
                if (activeTab) {
                    activeTab.element.classList.add('active');
                    this.activeSecondaryTab = activeTab;
                    
                    // 更新标签页内容
                    this.updateTabContent();
                }
            },
            
            // 更新标签页内容
            updateTabContent() {
                const tabContent = document.getElementById('tabContent');
                
                if (this.activePrimaryTab && this.activeSecondaryTab) {
                    // 如果标签页有存储的内容，显示它
                    if (this.activeSecondaryTab.content) {
                        tabContent.innerHTML = this.activeSecondaryTab.content;
                    } else {
                        // 否则显示默认内容
                        tabContent.innerHTML = `<div class="web-content-placeholder">
                            <i class="fas fa-browser"></i>
                            <h4>${this.activePrimaryTab.label} - ${this.activeSecondaryTab.label}</h4>
                            <p>此区域用于显示${this.activePrimaryTab.label}内容</p>
                            <p>当前标签页: ${this.activeSecondaryTab.id}</p>
                        </div>`;
                    }
                } else if (this.activePrimaryTab) {
                    // 没有二级标签页的情况
                    if (this.activePrimaryTab.id === 'dictionary') {
                        // 词典标签页
                        tabContent.innerHTML = `<div class="no-results">
                            <i class="fas fa-search"></i> 请输入搜索词查询词典
                        </div>`;
                    } else if (this.activePrimaryTab.id === 'api') {
                        // API标签页
                        tabContent.innerHTML = `<div class="no-results">
                            <i class="fas fa-search"></i> 请输入搜索词查询API
                        </div>`;
                    }
                }
            },
            
            // 设置标签页事件
            setupTabEvents() {
                // 一级标签页点击事件
                document.getElementById('primaryTabs').addEventListener('click', (e) => {
                    if (e.target.classList.contains('primary-tab')) {
                        const tabId = e.target.dataset.tabId;
                        this.setActivePrimaryTab(tabId);
                    }
                });
                
                // 二级标签页点击事件
                document.getElementById('secondaryTabs').addEventListener('click', (e) => {
                    if (e.target.classList.contains('secondary-tab')) {
                        const tabId = e.target.dataset.tabId;
                        this.setActiveSecondaryTab(tabId);
                    }
                });
            }
        };

        // 初始化模式选择
        function initModeSelector() {
            const modeDictionary = document.getElementById('modeDictionary');
            const modeWeb = document.getElementById('modeWeb');
            const modeAPI = document.getElementById('modeAPI');
            const modeTranslate = document.getElementById('modeTranslate');
            
            const modeDictionaryOption = document.getElementById('modeDictionaryOption');
            const modeWebOption = document.getElementById('modeWebOption');
            const modeAPIOption = document.getElementById('modeAPIOption');
            const modeTranslateOption = document.getElementById('modeTranslateOption');
            
            // 设置初始状态
            updateModeUI();
            
            // 添加事件监听器
            modeDictionary.addEventListener('change', function() {
                activeModes.dictionary = this.checked;
                updateModeUI();
                tabManager.updatePrimaryTabs();
            });
            
            modeWeb.addEventListener('change', function() {
                activeModes.web = this.checked;
                updateModeUI();
                tabManager.updatePrimaryTabs();
            });
            
            modeAPI.addEventListener('change', function() {
                activeModes.api = this.checked;
                updateModeUI();
                tabManager.updatePrimaryTabs();
            });
            
            modeTranslate.addEventListener('change', function() {
                activeModes.translate = this.checked;
                updateModeUI();
                tabManager.updatePrimaryTabs();
            });
        }
        
        // 更新模式选择UI
        function updateModeUI() {
            const modeDictionaryOption = document.getElementById('modeDictionaryOption');
            const modeWebOption = document.getElementById('modeWebOption');
            const modeAPIOption = document.getElementById('modeAPIOption');
            const modeTranslateOption = document.getElementById('modeTranslateOption');
            
            if (activeModes.dictionary) {
                modeDictionaryOption.classList.add('active');
            } else {
                modeDictionaryOption.classList.remove('active');
            }
            
            if (activeModes.web) {
                modeWebOption.classList.add('active');
            } else {
                modeWebOption.classList.remove('active');
            }
            
            if (activeModes.api) {
                modeAPIOption.classList.add('active');
            } else {
                modeAPIOption.classList.remove('active');
            }
            
            if (activeModes.translate) {
                modeTranslateOption.classList.add('active');
            } else {
                modeTranslateOption.classList.remove('active');
            }
        }

        // 加载词典数据
        async function loadDictionaryData() {
            try {
                console.log('开始加载词典数据...');
                
                // 显示加载状态
                document.getElementById('tabContent').innerHTML = `
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> 正在加载词典数据...
                    </div>
                `;

                // 加载index.json
                const indexResponse = await fetch('./dict/index.json');
                if (!indexResponse.ok) {
                    throw new Error('无法加载index.json文件');
                }
                dictionaryData.index = await indexResponse.json();
                
                // 尝试加载tag_bank文件
                try {
                    const tagBankResponse = await fetch('./dict/tag_bank_1.json');
                    if (tagBankResponse.ok) {
                        dictionaryData.tagBanks = await tagBankResponse.json();
                    }
                } catch (error) {
                    console.warn('无法加载tag_bank文件:', error);
                }

                // 加载所有term_bank文件
                let bankIndex = 1;
                let loadedBanks = 0;
                
                while (true) {
                    try {
                        const termBankResponse = await fetch(`./dict/term_bank_${bankIndex}.json`);
                        if (!termBankResponse.ok) {
                            break;
                        }
                        const termBankData = await termBankResponse.json();
                        dictionaryData.termBanks = dictionaryData.termBanks.concat(termBankData);
                        bankIndex++;
                        loadedBanks++;
                    } catch (error) {
                        break;
                    }
                }

                if (dictionaryData.termBanks.length === 0) {
                    throw new Error('未找到任何term_bank文件');
                }

                console.log(`成功加载词典: ${dictionaryData.index.title}`);
                console.log(`加载了 ${loadedBanks} 个term_bank文件，共 ${dictionaryData.termBanks.length} 个术语`);

                // 更新词典信息
                document.getElementById('tabContent').innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i> 词典加载完成，请输入搜索词
                    </div>
                `;

            } catch (error) {
                console.error('加载词典数据时出错:', error);
                document.getElementById('tabContent').innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-triangle"></i> 加载词典数据失败: ${error.message}
                    </div>
                `;
            }
        }

        // 执行搜索
        function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            const searchMode = document.getElementById('searchMode').value;
            const maxResults = parseInt(document.getElementById('maxResults').value);
            const caseSensitive = document.getElementById('caseSensitive').checked;
            
            if (!query) {
                alert('请输入搜索词');
                return;
            }
            
            // 根据当前激活的主标签页执行不同的搜索
            const activePrimaryTab = tabManager.activePrimaryTab;
            if (!activePrimaryTab) return;
            
            switch(activePrimaryTab.id) {
                case 'dictionary':
                    performDictionarySearch(query, searchMode, maxResults, caseSensitive);
                    break;
                case 'web':
                    performWebSearch(query);
                    break;
                case 'api':
                    performAPISearch(query);
                    break;
                case 'translate':
                    performTranslateSearch(query);
                    break;
            }
        }

        // 执行词典搜索
        function performDictionarySearch(query, searchMode, maxResults, caseSensitive) {
            document.getElementById('tabContent').innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> 正在搜索词典...
                </div>
            `;
            
            setTimeout(() => {
                let results = [];
                const searchQuery = caseSensitive ? query : query.toLowerCase();
                
                for (const term of dictionaryData.termBanks) {
                    if (!Array.isArray(term) || term.length < 2) continue;
                    
                    const expression = caseSensitive ? term[0] : (term[0] || '').toLowerCase();
                    const reading = caseSensitive ? term[1] : (term[1] || '').toLowerCase();
                    
                    let match = false;
                    
                    switch (searchMode) {
                        case 'exact':
                            match = expression === searchQuery || reading === searchQuery;
                            break;
                        case 'prefix':
                            match = expression.startsWith(searchQuery) || reading.startsWith(searchQuery);
                            break;
                        case 'suffix':
                            match = expression.endsWith(searchQuery) || reading.endsWith(searchQuery);
                            break;
                        case 'contains':
                            match = expression.includes(searchQuery) || reading.includes(searchQuery);
                            break;
                    }
                    
                    if (match) {
                        results.push(term);
                        if (results.length >= maxResults) {
                            break;
                        }
                    }
                }
                
                displayDictionaryResults(results, query);
            }, 100);
        }

        // 显示词典搜索结果
        function displayDictionaryResults(results, query) {
            const resultsContent = document.getElementById('tabContent');
            
            if (results.length === 0) {
                resultsContent.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i> 没有找到匹配"${query}"的术语
                    </div>
                `;
                return;
            }
            
            let html = '<div class="term-list">';
            
            for (const term of results) {
                if (!Array.isArray(term) || term.length < 6) continue;
                
                const expression = term[0] || '';
                const reading = term[1] || '';
                const definitionTags = term[2] || '';
                const score = term[4] || 0;
                const glossary = Array.isArray(term[5]) ? term[5] : [term[5] || ''];
                
                html += `
                    <div class="term-item">
                        <div class="term-heading">
                            <div>
                                <div class="term-expression">${escapeHtml(expression)}</div>
                                ${reading && reading !== expression ? `<div class="term-reading">${escapeHtml(reading)}</div>` : ''}
                            </div>
                            ${definitionTags ? `<span class="term-pos">${escapeHtml(definitionTags)}</span>` : ''}
                        </div>
                        <div class="term-definitions">
                            <ul class="definition-list">
                                ${glossary.map(def => `<li class="definition-item">${escapeHtml(def)}</li>`).join('')}
                            </ul>
                        </div>
                        ${score ? `<div style="margin-top: 10px; font-size: 0.8rem; color: #6c757d;">评分: ${score}</div>` : ''}
                    </div>
                `;
            }
            
            html += '</div>';
            resultsContent.innerHTML = html;
        }

        // 执行网页内容搜索
        function performWebSearch(query) {
            document.getElementById('tabContent').innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> 正在获取网页内容...
                </div>
            `;
            
            // 触发油猴脚本搜索
            if (window.YomitanInterface && window.YomitanInterface.onWebSearch) {
                window.YomitanInterface.onWebSearch(query, 'web');
            }
        }

        // 执行API搜索
        function performAPISearch(query) {
            document.getElementById('tabContent').innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> 正在查询API...
                </div>
            `;
            
            // 使用Free Dictionary API
            fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(query)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('未找到该词的释义');
                    }
                    return response.json();
                })
                .then(data => {
                    displayAPIResults(data, query);
                })
                .catch(error => {
                    document.getElementById('tabContent').innerHTML = `
                        <div class="error">
                            <i class="fas fa-exclamation-triangle"></i> API查询失败: ${error.message}
                        </div>
                    `;
                });
        }

        // 显示API搜索结果
        function displayAPIResults(data, query) {
            const resultsContent = document.getElementById('tabContent');
            
            if (!data || data.length === 0) {
                resultsContent.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i> 没有找到匹配"${query}"的API结果
                    </div>
                `;
                return;
            }
            
            let html = '<div class="api-results">';
            
            for (const entry of data) {
                html += `
                    <div class="api-item">
                        <div class="api-source">
                            <i class="fas fa-database"></i>
                            Free Dictionary API - ${entry.word}
                        </div>
                        <div class="api-content">
                `;
                
                if (entry.phonetic) {
                    html += `<p><strong>发音:</strong> ${entry.phonetic}</p>`;
                }
                
                if (entry.phonetics && entry.phonetics.length > 0) {
                    html += `<p><strong>音标:</strong> `;
                    entry.phonetics.forEach(phonetic => {
                        if (phonetic.text) {
                            html += `${phonetic.text} `;
                        }
                    });
                    html += `</p>`;
                }
                
                if (entry.meanings && entry.meanings.length > 0) {
                    entry.meanings.forEach(meaning => {
                        html += `<p><strong>${meaning.partOfSpeech}:</strong> `;
                        if (meaning.definitions && meaning.definitions.length > 0) {
                            meaning.definitions.forEach((def, index) => {
                                if (index < 3) { // 只显示前3个定义
                                    html += `${def.definition}; `;
                                }
                            });
                        }
                        html += `</p>`;
                    });
                }
                
                html += `</div></div>`;
            }
            
            html += '</div>';
            resultsContent.innerHTML = html;
        }

        // 执行翻译搜索
        function performTranslateSearch(query) {
            document.getElementById('tabContent').innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> 正在翻译...
                </div>
            `;
            
            // 触发油猴脚本翻译
            if (window.YomitanInterface && window.YomitanInterface.onTranslate) {
                window.YomitanInterface.onTranslate(query);
            }
        }

        // HTML转义函数
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 全局函数，供油猴脚本调用
        window.YomitanInterface = {
            // 添加新的二级标签页
            addSecondaryTab: function(primaryTabId, tabId, tabLabel, position = null) {
                // 确保指定的主标签页是激活状态
                if (tabManager.activePrimaryTab && tabManager.activePrimaryTab.id === primaryTabId) {
                    const newTab = tabManager.addSecondaryTab(tabId, tabLabel);
                    
                    // 如果指定了位置，调整标签页顺序
                    if (position !== null && position >= 0 && position < tabManager.secondaryTabs.length) {
                        const tabsContainer = document.getElementById('secondaryTabs');
                        const currentIndex = tabManager.secondaryTabs.findIndex(t => t.id === tabId);
                        if (currentIndex !== -1) {
                            // 从数组中移除
                            const [tab] = tabManager.secondaryTabs.splice(currentIndex, 1);
                            // 插入到指定位置
                            tabManager.secondaryTabs.splice(position, 0, tab);
                            
                            // 更新DOM
                            tabsContainer.innerHTML = '';
                            tabManager.secondaryTabs.forEach(t => {
                                tabsContainer.appendChild(t.element);
                            });
                        }
                    }
                    
                    return newTab;
                }
                return null;
            },
            
            // 设置激活的二级标签页
            setActiveSecondaryTab: function(tabId) {
                tabManager.setActiveSecondaryTab(tabId);
            },
            
            // 向标签页注入内容
            injectTabContent: function(tabId, htmlContent) {
                // 存储内容到对应的标签页
                const tab = tabManager.secondaryTabs.find(t => t.id === tabId);
                if (tab) {
                    tab.content = htmlContent;
                    
                    // 如果当前激活的标签页是目标标签页，直接更新内容
                    if (tabManager.activeSecondaryTab && tabManager.activeSecondaryTab.id === tabId) {
                        document.getElementById('tabContent').innerHTML = htmlContent;
                    }
                }
            },
            
            // 获取当前搜索查询
            getCurrentQuery: function() {
                return document.getElementById('searchInput').value.trim();
            },
            
            // 触发搜索
            triggerSearch: function() {
                performSearch();
            },
            
            // 油猴脚本可以实现的回调函数
            onWebSearch: null,
            onTranslate: null
        };

        // 设置事件监听器
        function setupEventListeners() {
            document.getElementById('searchBtn').addEventListener('click', performSearch);
            document.getElementById('searchInput').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        }

        // 初始化页面
        function init() {
            console.log('开始初始化页面...');
            initModeSelector();
            setupEventListeners();
            tabManager.init();
            loadDictionaryData().then(() => {
                console.log('页面初始化完成');
            }).catch(error => {
                console.error('初始化失败:', error);
            });
        }

        // 启动初始化
        init();
    </script>
</body>
</html>