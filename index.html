<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>移动端音频播放器 - 带字幕与Anki卡片生成</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #fff;
            min-height: 100vh;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 800px;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            margin-top: 15px;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            color: #ddd;
            font-size: 1rem;
        }
        
        .file-section {
            margin-bottom: 20px;
        }
        
        .file-controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .file-btn {
            background: rgba(52, 152, 219, 0.7);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            text-align: center;
            width: 100%;
        }
        
        .file-btn:hover, .file-btn:active {
            background: rgba(52, 152, 219, 1);
        }
        
        .file-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 15px;
        }
        
        .file-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px 15px;
        }
        
        .file-card h3 {
            font-size: 1rem;
            margin-bottom: 5px;
            color: #3498db;
        }
        
        .file-card p {
            font-size: 0.9rem;
            color: #bbb;
            word-break: break-all;
        }
        
        .player-section {
            margin-bottom: 25px;
        }
        
        .player-container {
            background: rgba(30, 30, 40, 0.9);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .audio-info {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .album-art {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            background: linear-gradient(45deg, #3498db, #8e44ad);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }
        
        .album-art i {
            font-size: 30px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .track-info h2 {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }
        
        .track-info p {
            color: #bbb;
            font-size: 0.9rem;
        }
        
        .plyr__controls {
            background: transparent;
        }
        
        .plyr--audio .plyr__controls {
            background: transparent;
            color: white;
            padding: 10px 5px;
        }
        
        .plyr--full-ui input[type=range] {
            color: #3498db;
        }
        
        .plyr--audio .plyr__control {
            padding: 10px;
        }
        
        .subtitle-section {
            margin-bottom: 25px;
        }
        
        .subtitle-display {
            background: rgba(30, 30, 40, 0.9);
            border-radius: 10px;
            padding: 15px;
            min-height: 100px;
            margin-bottom: 15px;
            line-height: 1.6;
            font-size: 1.1rem;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            user-select: text;
        }
        
        .subtitle-text {
            transition: all 0.3s;
        }
        
        .highlight {
            background-color: rgba(52, 152, 219, 0.3);
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .subtitle-controls {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .subtitle-btn {
            background: rgba(52, 152, 219, 0.7);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }
        
        .subtitle-btn:hover, .subtitle-btn:active {
            background: rgba(52, 152, 219, 1);
        }
        
        .hint {
            text-align: center;
            color: #bbb;
            font-size: 0.9rem;
            margin-top: 10px;
            line-height: 1.4;
        }
        
        footer {
            margin-top: 25px;
            text-align: center;
            color: #ddd;
            font-size: 0.8rem;
            padding: 0 10px;
        }
        
        .hidden {
            display: none;
        }
        
        .word {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .word:hover, .word:active {
            background-color: rgba(52, 152, 219, 0.2);
        }
        
        .loading {
            text-align: center;
            color: #3498db;
            font-style: italic;
        }

        .error {
            color: #e74c3c;
            text-align: center;
        }
        
        /* 新增样式 */
        .anki-section {
            margin-bottom: 20px;
        }
        
        .anki-container {
            background: rgba(30, 30, 40, 0.9);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .anki-status {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-connected {
            background-color: #2ecc71;
        }
        
        .status-disconnected {
            background-color: #e74c3c;
        }
        
        .anki-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .anki-btn {
            background: rgba(155, 89, 182, 0.7);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            flex: 1;
        }
        
        .anki-btn:hover, .anki-btn:active {
            background: rgba(155, 89, 182, 1);
        }
        
        .add-to-anki-btn {
            background: rgba(231, 76, 60, 0.7);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            margin-top: 15px;
            width: 100%;
        }
        
        .add-to-anki-btn:hover, .add-to-anki-btn:active {
            background: rgba(231, 76, 60, 1);
        }
        
        .config-section {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        
        .config-row {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
        
        .config-label {
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #bbb;
        }
        
        .config-input {
            padding: 8px 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9rem;
        }
        
        .audio-clip-section {
            margin-bottom: 10px;
        }
        
        .audio-clip-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .clip-time-display {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .clip-time {
            font-size: 0.9rem;
            color: #bbb;
        }
        
        .clip-btn {
            background: rgba(241, 196, 15, 0.7);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
        }
        
        .clip-btn:hover, .clip-btn:active {
            background: rgba(241, 196, 15, 1);
        }
        
        .clip-btn:disabled {
            background: rgba(149, 165, 166, 0.7);
            cursor: not-allowed;
        }
        
        .clip-status {
            text-align: center;
            font-size: 0.9rem;
            margin-top: 10px;
            min-height: 20px;
        }
        
        .custom-definition {
            margin-top: 15px;
        }
        
        .custom-definition textarea {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 80px;
        }
        
        /* 播放器中的截取控件 */
        .clip-controls-in-player {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding: 8px 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
        }
        
        .clip-time-in-player {
            font-size: 0.8rem;
            color: #bbb;
        }
        
        .clip-buttons-in-player {
            display: flex;
            gap: 5px;
        }
        
        /* 底部弹出面板 */
        .dictionary-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(30, 30, 40, 0.95);
            border-radius: 15px 15px 0 0;
            padding: 20px;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            z-index: 1000;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .dictionary-panel.active {
            transform: translateY(0);
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .panel-title {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .close-panel {
            background: none;
            border: none;
            color: #e74c3c;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }
        
        .panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
        }
        
        .panel-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* 自动检测的牌组和字段选择 */
        .auto-config-section {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        
        .auto-config-row {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
        
        .auto-config-label {
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #bbb;
        }
        
        .auto-config-select {
            padding: 8px 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9rem;
        }
        
        /* 词典面板中的搜索框 */
        .panel-search {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .panel-search-input {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }
        
        .panel-search-btn {
            background: rgba(46, 204, 113, 0.7);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }
        
        .panel-search-btn:hover, .panel-search-btn:active {
            background: rgba(46, 204, 113, 1);
        }
        
        /* 原句显示区域 */
        .original-sentence {
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            line-height: 1.5;
            font-size: 1rem;
        }
        
        .sentence-word {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .sentence-word:hover, .sentence-word:active {
            background-color: rgba(52, 152, 219, 0.2);
        }
        
        /* 移动设备横屏适配 */
        @media (min-width: 768px) {
            .container {
                padding: 25px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .file-controls {
                flex-direction: row;
            }
            
            .file-btn {
                flex: 1;
            }
            
            .file-info {
                flex-direction: row;
            }
            
            .word-header {
                flex-direction: row;
                align-items: center;
            }
            
            .anki-controls {
                flex-direction: row;
            }
            
            .config-row {
                flex-direction: row;
                align-items: center;
            }
            
            .config-label {
                width: 120px;
                margin-bottom: 0;
                margin-right: 10px;
            }
            
            .config-input {
                flex: 1;
            }
            
            .audio-clip-controls {
                flex-direction: row;
            }
            
            .clip-controls-in-player {
                flex-direction: row;
            }
            
            .clip-buttons-in-player {
                gap: 8px;
            }
            
            .auto-config-row {
                flex-direction: row;
                align-items: center;
            }
            
            .auto-config-label {
                width: 120px;
                margin-bottom: 0;
                margin-right: 10px;
            }
            
            .auto-config-select {
                flex: 1;
            }
            
            /* PC端底部面板样式 */
            .dictionary-panel {
                left: 50%;
                right: auto;
                width: 90%;
                max-width: 600px;
                transform: translate(-50%, 100%);
                border-radius: 15px;
            }
            
            .dictionary-panel.active {
                transform: translate(-50%, 0);
                bottom: 20px;
            }
        }
        
        /* 小屏幕手机适配 */
        @media (max-width: 360px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.6rem;
            }
            
            .album-art {
                width: 70px;
                height: 70px;
                margin-right: 12px;
            }
            
            .track-info h2 {
                font-size: 1.2rem;
            }
            
            .subtitle-display {
                font-size: 1rem;
                padding: 12px;
            }
            
            .clip-btn {
                padding: 6px 10px;
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>移动端音频播放器 - Anki卡片生成</h1>
        <p class="subtitle">支持音频截取、字幕显示与Anki卡片生成功能</p>
    </header>
    
    <div class="container">
        <section class="file-section">
            <div class="file-controls">
                <button class="file-btn" id="audio-file-btn">选择音频/视频文件</button>
                <button class="file-btn" id="subtitle-file-btn">选择字幕文件</button>
                <input type="file" id="audio-file-input" accept="audio/*,video/*" class="hidden">
                <input type="file" id="subtitle-file-input" accept=".srt,.vtt,.txt" class="hidden">
            </div>
            <div class="file-info">
                <div class="file-card">
                    <h3>音频/视频文件</h3>
                    <p id="audio-file-name">未选择文件</p>
                </div>
                <div class="file-card">
                    <h3>字幕文件</h3>
                    <p id="subtitle-file-name">未选择文件</p>
                </div>
            </div>
        </section>
        
        <section class="player-section">
            <div class="player-container">
                <div class="audio-info">
                    <div class="album-art">
                        <i>♪</i>
                    </div>
                    <div class="track-info">
                        <h2 id="track-title">请选择音频/视频文件</h2>
                        <p id="track-description">支持 MP3, WAV, OGG, MP4, AVI 等格式</p>
                    </div>
                </div>
                
                <audio id="player" controls>
                    <!-- 音频源将通过JavaScript动态设置 -->
                </audio>
                
                <div class="clip-controls-in-player">
                    <div class="clip-time-in-player">
                        片段: <span id="start-time-player">0.00</span>s - <span id="end-time-player">0.00</span>s
                    </div>
                    <div class="clip-buttons-in-player">
                        <button class="clip-btn" id="set-start-btn-player">开始</button>
                        <button class="clip-btn" id="set-end-btn-player">结束</button>
                        <button class="clip-btn" id="clip-audio-btn-player" disabled>截取</button>
                    </div>
                </div>
                <div class="clip-status" id="clip-status-player"></div>
            </div>
        </section>
        
        <section class="subtitle-section">
            <div class="subtitle-display" id="subtitle-display">
                <div class="subtitle-text" id="subtitle-text">
                    请先选择音频/视频和字幕文件<br>
                    <strong>点击字幕中的单词即可查询其含义</strong>
                </div>
            </div>
            <div class="subtitle-controls">
                <button class="subtitle-btn" id="toggle-subtitle-btn">显示/隐藏字幕</button>
            </div>
            <p class="hint">提示：直接点击字幕中的单词，该单词会自动查询并显示释义</p>
        </section>
        
        <section class="anki-section">
            <div class="anki-container">
                <div class="anki-status">
                    <div class="status-indicator" id="anki-status-indicator"></div>
                    <span id="anki-status-text">检查Anki连接状态...</span>
                </div>
                <div class="anki-controls">
                    <button class="anki-btn" id="check-anki-btn">检查连接</button>
                    <button class="anki-btn" id="show-config-btn">配置设置</button>
                </div>
                <div class="auto-config-section hidden" id="auto-config-section">
                    <div class="auto-config-row">
                        <label class="auto-config-label" for="deck-select">牌组:</label>
                        <select class="auto-config-select" id="deck-select">
                            <option value="">加载中...</option>
                        </select>
                    </div>
                    <div class="auto-config-row">
                        <label class="auto-config-label" for="model-select">笔记类型:</label>
                        <select class="auto-config-select" id="model-select">
                            <option value="">加载中...</option>
                        </select>
                    </div>
                    <div class="auto-config-row">
                        <label class="auto-config-label" for="word-field-select">单词字段:</label>
                        <select class="auto-config-select" id="word-field-select">
                            <option value="">加载中...</option>
                        </select>
                    </div>
                    <div class="auto-config-row">
                        <label class="auto-config-label" for="sentence-field-select">句子字段:</label>
                        <select class="auto-config-select" id="sentence-field-select">
                            <option value="">加载中...</option>
                        </select>
                    </div>
                    <div class="auto-config-row">
                        <label class="auto-config-label" for="definition-field-select">释义字段:</label>
                        <select class="auto-config-select" id="definition-field-select">
                            <option value="">加载中...</option>
                        </select>
                    </div>
                    <div class="auto-config-row">
                        <label class="auto-config-label" for="audio-field-select">音频字段:</label>
                        <select class="auto-config-select" id="audio-field-select">
                            <option value="">加载中...</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>
    </div>
    
    <!-- 底部弹出面板 -->
    <div class="panel-overlay" id="panel-overlay"></div>
    <div class="dictionary-panel" id="dictionary-panel">
        <div class="panel-header">
            <div class="panel-title" id="panel-word-title">单词查询</div>
            <button class="close-panel" id="close-panel">×</button>
        </div>
        
        <div class="panel-search">
            <input type="text" class="panel-search-input" id="panel-search-input" placeholder="输入要查询的单词...">
            <button class="panel-search-btn" id="panel-search-btn">查询</button>
        </div>
        
        <div class="original-sentence" id="original-sentence">
            原句将显示在这里...
        </div>
        
        <div class="dictionary-result" id="panel-dictionary-result">
            查询结果将显示在这里...
        </div>
        
        <div class="custom-definition">
            <textarea id="panel-custom-definition-input" placeholder="如果查词没有返回内容或者想自定义释义内容，请在此输入..."></textarea>
        </div>
        <button class="add-to-anki-btn" id="panel-add-to-anki-btn">添加到Anki</button>
    </div>
    
    <footer>
        <p>网页音频播放器 - 专为语言学习设计 | 使用 Plyr 播放器 | 部署于 GitHub Pages</p>
    </footer>

    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <script>
        // 初始化Plyr播放器 
        const player = new Plyr('#player', {
            controls: [
                'play',
                'progress',
                'current-time',
                'duration',
                'mute',
                'volume'
            ]
        });

        // 获取DOM元素
        const audioFileBtn = document.getElementById('audio-file-btn');
        const subtitleFileBtn = document.getElementById('subtitle-file-btn');
        const audioFileInput = document.getElementById('audio-file-input');
        const subtitleFileInput = document.getElementById('subtitle-file-input');
        const audioFileName = document.getElementById('audio-file-name');
        const subtitleFileName = document.getElementById('subtitle-file-name');
        const trackTitle = document.getElementById('track-title');
        const trackDescription = document.getElementById('track-description');
        const subtitleText = document.getElementById('subtitle-text');
        const toggleSubtitleBtn = document.getElementById('toggle-subtitle-btn');
        const subtitleDisplay = document.getElementById('subtitle-display');
        
        // Anki相关元素
        const ankiStatusIndicator = document.getElementById('anki-status-indicator');
        const ankiStatusText = document.getElementById('anki-status-text');
        const checkAnkiBtn = document.getElementById('check-anki-btn');
        const showConfigBtn = document.getElementById('show-config-btn');
        const autoConfigSection = document.getElementById('auto-config-section');
        const addToAnkiBtn = document.getElementById('panel-add-to-anki-btn');
        const customDefinitionInput = document.getElementById('panel-custom-definition-input');
        
        // 音频截取相关元素
        const setStartBtnPlayer = document.getElementById('set-start-btn-player');
        const setEndBtnPlayer = document.getElementById('set-end-btn-player');
        const clipAudioBtnPlayer = document.getElementById('clip-audio-btn-player');
        const startTimeDisplayPlayer = document.getElementById('start-time-player');
        const endTimeDisplayPlayer = document.getElementById('end-time-player');
        const clipStatusPlayer = document.getElementById('clip-status-player');
        
        // 自动配置相关元素
        const deckSelect = document.getElementById('deck-select');
        const modelSelect = document.getElementById('model-select');
        const wordFieldSelect = document.getElementById('word-field-select');
        const sentenceFieldSelect = document.getElementById('sentence-field-select');
        const definitionFieldSelect = document.getElementById('definition-field-select');
        const audioFieldSelect = document.getElementById('audio-field-select');
        
        // 底部面板相关元素
        const dictionaryPanel = document.getElementById('dictionary-panel');
        const panelOverlay = document.getElementById('panel-overlay');
        const closePanelBtn = document.getElementById('close-panel');
        const panelDictionaryResult = document.getElementById('panel-dictionary-result');
        const panelWordTitle = document.getElementById('panel-word-title');
        const panelSearchInput = document.getElementById('panel-search-input');
        const panelSearchBtn = document.getElementById('panel-search-btn');
        const originalSentence = document.getElementById('original-sentence');
        
        // 状态变量
        let subtitles = [];
        let subtitleVisible = true;
        let currentHighlightedWord = null;
        let currentWord = '';
        let currentSentence = '';
        let currentSubtitleStart = 0;
        let currentSubtitleEnd = 0;
        let currentAudioClip = null;
        let clipStartTime = 0;
        let clipEndTime = 0;
        let ankiConnected = false;
        let ankiDecks = [];
        let ankiModels = [];
        let currentModelFields = [];
        let audioFile = null;
        let playerWasPlaying = false;

        // 文件选择事件处理
        audioFileBtn.addEventListener('click', () => {
            audioFileInput.click();
        });
        
        subtitleFileBtn.addEventListener('click', () => {
            subtitleFileInput.click();
        });
        
        // 音频/视频文件选择处理
        audioFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                audioFile = file;
                audioFileName.textContent = file.name;
                trackTitle.textContent = file.name.replace(/\.[^/.]+$/, ""); // 移除扩展名
                trackDescription.textContent = `文件大小: ${(file.size / 1024 / 1024).toFixed(2)} MB`;
                
                // 创建文件URL并设置播放器源
                const fileURL = URL.createObjectURL(file);
                const audioElement = document.querySelector('#player');
                
                // 清除之前的源
                while (audioElement.firstChild) {
                    audioElement.removeChild(audioElement.firstChild);
                }
                
                // 添加新的源
                const source = document.createElement('source');
                source.src = fileURL;
                source.type = file.type;
                audioElement.appendChild(source);
                
                // 重新加载播放器
                player.source = {
                    type: 'audio',
                    sources: [{
                        src: fileURL,
                        type: file.type
                    }]
                };
                
                // 重置字幕
                subtitles = [];
                subtitleText.innerHTML = "请加载字幕文件<br><strong>点击字幕中的单词即可查询其含义</strong>";
                
                // 重置音频截取
                clipStartTime = 0;
                clipEndTime = 0;
                startTimeDisplayPlayer.textContent = '0.00';
                endTimeDisplayPlayer.textContent = '0.00';
                clipAudioBtnPlayer.disabled = true;
                clipStatusPlayer.textContent = '';
                currentAudioClip = null;
            }
        });
        
        // 字幕文件选择处理
        subtitleFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                subtitleFileName.textContent = file.name;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    parseSubtitle(content);
                };
                reader.readAsText(file);
            }
        });
        
        // 解析字幕文件（简单SRT格式解析）
        function parseSubtitle(content) {
            subtitles = [];
            
            // 简单的SRT解析器
            const blocks = content.split(/\n\s*\n/);
            
            blocks.forEach(block => {
                const lines = block.trim().split('\n');
                if (lines.length >= 3) {
                    // 第一行是序号，跳过
                    // 第二行是时间轴
                    const timeLine = lines[1];
                    const timeMatch = timeLine.match(/(\d+):(\d+):(\d+),(\d+)\s*-->\s*(\d+):(\d+):(\d+),(\d+)/);
                    
                    if (timeMatch) {
                        const startTime = 
                            parseInt(timeMatch[1]) * 3600 + 
                            parseInt(timeMatch[2]) * 60 + 
                            parseInt(timeMatch[3]) + 
                            parseInt(timeMatch[4]) / 1000;
                        
                        const endTime = 
                            parseInt(timeMatch[5]) * 3600 + 
                            parseInt(timeMatch[6]) * 60 + 
                            parseInt(timeMatch[7]) + 
                            parseInt(timeMatch[8]) / 1000;
                        
                        // 第三行及之后是字幕文本
                        const text = lines.slice(2).join(' ').trim();
                        
                        if (text) {
                            subtitles.push({
                                start: startTime,
                                end: endTime,
                                text: text
                            });
                        }
                    }
                }
            });
            
            // 如果没有解析到字幕，使用默认字幕
            if (subtitles.length === 0) {
                subtitles = [
                    { start: 0, end: 5, text: "Welcome to our English learning audio player." },
                    { start: 5, end: 10, text: "This player supports subtitles and vocabulary lookup." },
                    { start: 10, end: 15, text: "You can select any word in the subtitle to look up its meaning." },
                    { start: 15, end: 20, text: "This is especially useful for language learners." },
                    { start: 20, end: 25, text: "Let's begin our English learning journey!" }
                ];
            }
            
            // 按开始时间排序
            subtitles.sort((a, b) => a.start - b.start);
            
            // 更新初始字幕显示
            updateSubtitle(0);
        }

        // 更新字幕显示
        function updateSubtitle(currentTime) {
            if (subtitles.length === 0) return;
            
            const currentSubtitle = subtitles.find(sub => 
                currentTime >= sub.start && currentTime < sub.end
            );
            
            if (currentSubtitle) {
                // 记录当前字幕的时间轴
                currentSubtitleStart = currentSubtitle.start;
                currentSubtitleEnd = currentSubtitle.end;
                
                // 改进的字幕文本转换，修复句末单词无法点击的问题
                // 使用更复杂的正则表达式匹配单词，包括句末单词
                const text = currentSubtitle.text;
                
                // 使用正则表达式匹配单词，包括带有标点符号的单词
                const wordRegex = /[a-zA-Z]+(?:['’][a-zA-Z]+)*/g;
                let lastIndex = 0;
                let clickableWords = '';
                
                let match;
                while ((match = wordRegex.exec(text)) !== null) {
                    // 添加匹配前的非单词部分
                    clickableWords += text.substring(lastIndex, match.index);
                    
                    // 添加可点击的单词
                    clickableWords += `<span class="word" data-word="${match[0]}">${match[0]}</span>`;
                    
                    lastIndex = match.index + match[0].length;
                }
                
                // 添加剩余的非单词部分
                clickableWords += text.substring(lastIndex);
                
                subtitleText.innerHTML = clickableWords;
                
                // 为每个单词添加点击事件
                document.querySelectorAll('.word').forEach(wordElem => {
                    wordElem.addEventListener('click', function() {
                        const word = this.getAttribute('data-word');
                        
                        // 点击单词时暂停播放
                        playerWasPlaying = !player.paused;
                        player.pause();
                        
                        // 查询单词并显示底部面板
                        searchWordInPanel(word);
                        
                        // 高亮显示选中的单词
                        if (currentHighlightedWord) {
                            currentHighlightedWord.classList.remove('highlight');
                        }
                        this.classList.add('highlight');
                        currentHighlightedWord = this;
                        
                        // 记录当前单词和句子
                        currentWord = word;
                        currentSentence = currentSubtitle.text;
                        
                        // 更新原句显示
                        updateOriginalSentence(currentSubtitle.text, word);
                        
                        // 自动截取当前字幕时间轴的音频
                        autoClipCurrentSubtitle();
                    });
                });
                
                subtitleText.style.opacity = '1';
            } else {
                subtitleText.style.opacity = '0.5';
            }
        }

        // 更新原句显示，使单词可点击
        function updateOriginalSentence(sentence, currentWord) {
            // 使用正则表达式匹配单词，包括带有标点符号的单词
            const wordRegex = /[a-zA-Z]+(?:['’][a-zA-Z]+)*/g;
            let lastIndex = 0;
            let clickableSentence = '';
            
            let match;
            while ((match = wordRegex.exec(sentence)) !== null) {
                // 添加匹配前的非单词部分
                clickableSentence += sentence.substring(lastIndex, match.index);
                
                // 添加可点击的单词，当前单词高亮显示
                const wordClass = match[0].toLowerCase() === currentWord.toLowerCase() ? 'sentence-word highlight' : 'sentence-word';
                clickableSentence += `<span class="${wordClass}" data-word="${match[0]}">${match[0]}</span>`;
                
                lastIndex = match.index + match[0].length;
            }
            
            // 添加剩余的非单词部分
            clickableSentence += sentence.substring(lastIndex);
            
            originalSentence.innerHTML = clickableSentence;
            
            // 为原句中的单词添加点击事件
            document.querySelectorAll('.sentence-word').forEach(wordElem => {
                wordElem.addEventListener('click', function() {
                    const word = this.getAttribute('data-word');
                    panelSearchInput.value = word;
                    searchWordInPanel(word);
                    
                    // 高亮显示选中的单词
                    document.querySelectorAll('.sentence-word').forEach(w => {
                        w.classList.remove('highlight');
                    });
                    this.classList.add('highlight');
                    
                    // 更新当前单词
                    currentWord = word;
                });
            });
        }

        // 自动截取当前字幕时间轴的音频
        function autoClipCurrentSubtitle() {
            if (currentSubtitleStart >= currentSubtitleEnd) {
                console.log('字幕时间轴无效');
                return;
            }
            
            // 使用当前字幕的时间轴
            clipStartTime = currentSubtitleStart;
            clipEndTime = currentSubtitleEnd;
            
            // 更新显示
            startTimeDisplayPlayer.textContent = clipStartTime.toFixed(2);
            endTimeDisplayPlayer.textContent = clipEndTime.toFixed(2);
            
            // 创建音频片段
            createAudioClip(clipStartTime, clipEndTime);
        }

        // 创建音频片段
        async function createAudioClip(startTime, endTime) {
            if (!audioFile) {
                clipStatusPlayer.textContent = '错误：没有音频文件';
                return;
            }
            
            clipStatusPlayer.textContent = '正在创建音频片段...';
            
            try {
                // 这里简化实现，实际应用中需要更复杂的音频处理
                // 由于浏览器限制，这里我们只是模拟音频截取
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 创建音频片段数据
                const audioClipData = await generateAudioClipData(startTime, endTime);
                
                // 保存音频片段
                currentAudioClip = {
                    start: startTime,
                    end: endTime,
                    data: audioClipData
                };
                
                clipStatusPlayer.textContent = `音频片段已创建 (${startTime.toFixed(2)}s - ${endTime.toFixed(2)}s)`;
            } catch (error) {
                clipStatusPlayer.textContent = '音频片段创建失败: ' + error.message;
                console.error('音频片段创建错误:', error);
            }
        }

        // 生成音频片段数据（模拟）
        async function generateAudioClipData(startTime, endTime) {
            // 在实际应用中，这里应该使用Web Audio API或其他库来截取音频
            // 由于浏览器限制，这里我们只是生成一个模拟的音频文件名
            
            // 创建一个包含时间信息的唯一文件名
            const fileName = `audio_clip_${startTime.toFixed(2)}_${endTime.toFixed(2)}.mp3`;
            
            // 在实际应用中，这里应该返回实际的音频数据或URL
            // 这里我们返回一个模拟的音频数据对象
            return {
                fileName: fileName,
                startTime: startTime,
                endTime: endTime,
                // 在实际应用中，这里应该包含实际的音频数据
                data: `模拟音频数据: ${fileName}`
            };
        }

        // 在面板中查询单词
        async function searchWordInPanel(word) {
            if (!word.trim()) {
                panelDictionaryResult.innerHTML = '<div class="error">请输入要查询的单词</div>';
                return;
            }
            
            panelDictionaryResult.innerHTML = '<div class="loading">查询中...</div>';
            panelWordTitle.textContent = `查询: ${word}`;
            panelSearchInput.value = word;
            
            try {
                const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error(`未找到单词 "${word}" 的定义`);
                    } else {
                        throw new Error(`API请求失败: ${response.status}`);
                    }
                }
                
                const data = await response.json();
                displayWordDataInPanel(data[0]);
            } catch (error) {
                panelDictionaryResult.innerHTML = `<div class="error">${error.message}</div>`;
                console.error('查询错误:', error);
            }
        }
        
        // 显示单词数据在底部面板
        function displayWordDataInPanel(wordData) {
            let html = '';
            
            // 单词标题和音标
            html += `<div class="word-header">`;
            html += `<div class="word-title">${wordData.word}</div>`;
            
            if (wordData.phonetic) {
                html += `<div class="phonetic">${wordData.phonetic}</div>`;
            } else if (wordData.phonetics && wordData.phonetics.length > 0) {
                const phonetic = wordData.phonetics.find(p => p.text) || wordData.phonetics[0];
                if (phonetic && phonetic.text) {
                    html += `<div class="phonetic">${phonetic.text}</div>`;
                }
            }
            
            html += `</div>`;
            
            // 词义解释
            if (wordData.meanings && wordData.meanings.length > 0) {
                wordData.meanings.forEach(meaning => {
                    html += `<div class="meaning-section">`;
                    html += `<div class="part-of-speech">${meaning.partOfSpeech}</div>`;
                    
                    if (meaning.definitions && meaning.definitions.length > 0) {
                        meaning.definitions.forEach((def, index) => {
                            if (index < 3) { // 只显示前三个定义
                                html += `<div class="definition">${index + 1}. ${def.definition}</div>`;
                                if (def.example) {
                                    html += `<div class="example">例句: "${def.example}"</div>`;
                                }
                            }
                        });
                    }
                    
                    html += `</div>`;
                });
            } else {
                html += `<div class="meaning-section">`;
                html += `<div class="definition">未找到该单词的详细释义。</div>`;
                html += `</div>`;
            }
            
            panelDictionaryResult.innerHTML = html;
        }
        
        // 显示/隐藏字幕
        toggleSubtitleBtn.addEventListener('click', () => {
            subtitleVisible = !subtitleVisible;
            subtitleDisplay.style.display = subtitleVisible ? 'block' : 'none';
        });
        
        // 音频截取功能
        setStartBtnPlayer.addEventListener('click', () => {
            clipStartTime = player.currentTime;
            startTimeDisplayPlayer.textContent = clipStartTime.toFixed(2);
            updateClipButtonState();
        });
        
        setEndBtnPlayer.addEventListener('click', () => {
            clipEndTime = player.currentTime;
            endTimeDisplayPlayer.textContent = clipEndTime.toFixed(2);
            updateClipButtonState();
        });
        
        function updateClipButtonState() {
            clipAudioBtnPlayer.disabled = clipStartTime >= clipEndTime || clipEndTime === 0;
        }
        
        clipAudioBtnPlayer.addEventListener('click', async () => {
            if (clipStartTime >= clipEndTime) {
                clipStatusPlayer.textContent = '错误：开始时间必须小于结束时间';
                return;
            }
            
            // 创建音频片段
            await createAudioClip(clipStartTime, clipEndTime);
        });
        
        // Anki连接检查
        async function checkAnkiConnection() {
            ankiStatusText.textContent = '检查Anki连接状态...';
            
            try {
                const response = await fetch('http://127.0.0.1:8765', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'version',
                        version: 6
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.result) {
                        ankiConnected = true;
                        ankiStatusIndicator.className = 'status-indicator status-connected';
                        ankiStatusText.textContent = 'Anki已连接';
                        
                        // 获取牌组和模型信息
                        await loadAnkiDecks();
                        await loadAnkiModels();
                    } else {
                        throw new Error('AnkiConnect响应错误');
                    }
                } else {
                    throw new Error('AnkiConnect响应错误');
                }
            } catch (error) {
                ankiConnected = false;
                ankiStatusIndicator.className = 'status-indicator status-disconnected';
                ankiStatusText.textContent = 'Anki未连接 - 请确保Anki正在运行并安装了AnkiConnect插件';
                console.error('Anki连接错误:', error);
            }
        }
        
        // 获取Anki牌组列表
        async function loadAnkiDecks() {
            try {
                const response = await fetch('http://127.0.0.1:8765', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'deckNames',
                        version: 6
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    ankiDecks = data.result;
                    
                    // 更新牌组选择框
                    deckSelect.innerHTML = '';
                    ankiDecks.forEach(deck => {
                        const option = document.createElement('option');
                        option.value = deck;
                        option.textContent = deck;
                        deckSelect.appendChild(option);
                    });
                    
                    // 默认选择第一个牌组
                    if (ankiDecks.length > 0) {
                        deckSelect.value = ankiDecks[0];
                    }
                }
            } catch (error) {
                console.error('获取牌组列表错误:', error);
            }
        }
        
        // 获取Anki模型列表
        async function loadAnkiModels() {
            try {
                const response = await fetch('http://127.0.0.1:8765', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'modelNames',
                        version: 6
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    ankiModels = data.result;
                    
                    // 更新模型选择框
                    modelSelect.innerHTML = '';
                    ankiModels.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });
                    
                    // 默认选择第一个模型并加载字段
                    if (ankiModels.length > 0) {
                        modelSelect.value = ankiModels[0];
                        await loadModelFields(ankiModels[0]);
                    }
                }
            } catch (error) {
                console.error('获取模型列表错误:', error);
            }
        }
        
        // 获取模型字段
        async function loadModelFields(modelName) {
            try {
                const response = await fetch('http://127.0.0.1:8765', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'modelFieldNames',
                        version: 6,
                        params: {
                            modelName: modelName
                        }
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentModelFields = data.result;
                    
                    // 更新字段选择框
                    wordFieldSelect.innerHTML = '';
                    sentenceFieldSelect.innerHTML = '';
                    definitionFieldSelect.innerHTML = '';
                    audioFieldSelect.innerHTML = '';
                    
                    currentModelFields.forEach(field => {
                        const option = document.createElement('option');
                        option.value = field;
                        option.textContent = field;
                        
                        wordFieldSelect.appendChild(option.cloneNode(true));
                        sentenceFieldSelect.appendChild(option.cloneNode(true));
                        definitionFieldSelect.appendChild(option.cloneNode(true));
                        audioFieldSelect.appendChild(option.cloneNode(true));
                    });
                    
                    // 尝试智能设置默认字段
                    setDefaultFields();
                }
            } catch (error) {
                console.error('获取模型字段错误:', error);
            }
        }
        
        // 智能设置默认字段
        function setDefaultFields() {
            const fields = currentModelFields.map(f => f.toLowerCase());
            
            // 设置单词字段
            if (fields.includes('word')) {
                wordFieldSelect.value = 'word';
            } else if (fields.includes('front')) {
                wordFieldSelect.value = 'front';
            } else if (fields.length > 0) {
                wordFieldSelect.selectedIndex = 0;
            }
            
            // 设置句子字段
            if (fields.includes('sentence')) {
                sentenceFieldSelect.value = 'sentence';
            } else if (fields.includes('example')) {
                sentenceFieldSelect.value = 'example';
            } else if (fields.includes('back')) {
                sentenceFieldSelect.value = 'back';
            } else if (fields.length > 1) {
                sentenceFieldSelect.selectedIndex = 1;
            }
            
            // 设置释义字段
            if (fields.includes('definition')) {
                definitionFieldSelect.value = 'definition';
            } else if (fields.includes('meaning')) {
                definitionFieldSelect.value = 'meaning';
            } else if (fields.includes('back')) {
                definitionFieldSelect.value = 'back';
            } else if (fields.length > 2) {
                definitionFieldSelect.selectedIndex = 2;
            }
            
            // 设置音频字段
            if (fields.includes('audio')) {
                audioFieldSelect.value = 'audio';
            } else if (fields.includes('sound')) {
                audioFieldSelect.value = 'sound';
            } else if (fields.length > 3) {
                audioFieldSelect.selectedIndex = 3;
            }
        }
        
        // 检查Anki连接
        checkAnkiBtn.addEventListener('click', checkAnkiConnection);
        
        // 显示/隐藏配置
        showConfigBtn.addEventListener('click', () => {
            const isHidden = autoConfigSection.classList.contains('hidden');
            if (isHidden) {
                autoConfigSection.classList.remove('hidden');
                showConfigBtn.textContent = '隐藏配置';
            } else {
                autoConfigSection.classList.add('hidden');
                showConfigBtn.textContent = '配置设置';
            }
        });
        
        // 模型选择变化时加载字段
        modelSelect.addEventListener('change', () => {
            loadModelFields(modelSelect.value);
        });
        
        // 添加到Anki
        addToAnkiBtn.addEventListener('click', async () => {
            if (!ankiConnected) {
                alert('请先连接Anki!');
                return;
            }
            
            const word = panelSearchInput.value.trim();
            if (!word) {
                alert('请输入要添加的单词!');
                return;
            }
            
            // 获取词典内容
            let definition = '';
            const definitionElements = panelDictionaryResult.querySelectorAll('.definition');
            if (definitionElements.length > 0) {
                definitionElements.forEach(el => {
                    definition += el.textContent + '\n';
                });
            }
            
            // 如果用户输入了自定义释义，使用自定义释义
            const customDefinition = customDefinitionInput.value.trim();
            if (customDefinition) {
                definition = customDefinition;
            }
            
            if (!definition) {
                alert('请提供单词释义!');
                return;
            }
            
            // 准备音频数据
            let audioData = '';
            if (currentAudioClip) {
                // 在实际应用中，这里应该将音频数据发送到Anki
                // 由于浏览器限制，这里我们只发送时间信息
                audioData = `[sound:${currentAudioClip.data.fileName}]`;
            }
            
            // 准备Anki卡片数据
            const note = {
                deckName: deckSelect.value,
                modelName: modelSelect.value,
                fields: {
                    [wordFieldSelect.value]: word,
                    [sentenceFieldSelect.value]: currentSentence,
                    [definitionFieldSelect.value]: definition,
                    [audioFieldSelect.value]: audioData
                },
                options: {
                    allowDuplicate: false
                },
                tags: ['audio-player']
            };
            
            try {
                const response = await fetch('http://127.0.0.1:8765', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'addNote',
                        version: 6,
                        params: {
                            note: note
                        }
                    })
                });
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                alert('卡片已成功添加到Anki!');
                
                // 关闭面板
                closeDictionaryPanel();
                
                // 重置表单
                customDefinitionInput.value = '';
                panelSearchInput.value = '';
                panelDictionaryResult.innerHTML = '查询结果将显示在这里...';
                
            } catch (error) {
                alert('添加卡片失败: ' + error.message);
                console.error('Anki添加卡片错误:', error);
            }
        });
        
        // 底部面板功能
        function openDictionaryPanel() {
            dictionaryPanel.classList.add('active');
            panelOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeDictionaryPanel() {
            dictionaryPanel.classList.remove('active');
            panelOverlay.classList.remove('active');
            document.body.style.overflow = '';
            
            // 恢复播放
            if (playerWasPlaying && player.paused) {
                player.play();
            }
        }
        
        closePanelBtn.addEventListener('click', closeDictionaryPanel);
        panelOverlay.addEventListener('click', closeDictionaryPanel);
        
        // 面板搜索功能
        panelSearchBtn.addEventListener('click', () => {
            const word = panelSearchInput.value.trim();
            searchWordInPanel(word);
        });
        
        panelSearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const word = panelSearchInput.value.trim();
                searchWordInPanel(word);
            }
        });
        
        // 监听播放器时间更新
        player.on('timeupdate', event => {
            updateSubtitle(player.currentTime);
        });
        
        // 初始化
        function init() {
            // 检查Anki连接
            checkAnkiConnection();
            
            // 初始化默认字幕
            parseSubtitle(`1
00:00:00,000 --> 00:00:05,000
Welcome to our English learning audio player.

2
00:00:05,000 --> 00:00:10,000
This player supports subtitles and vocabulary lookup.

3
00:00:10,000 --> 00:00:15,000
You can select any word in the subtitle to look up its meaning.

4
00:00:15,000 --> 00:00:20,000
This is especially useful for language learners.

5
00:00:20,000 --> 00:00:25,000
Let's begin our English learning journey!`);
        }
        
        // 启动初始化
        init();
    </script>
</body>
</html>