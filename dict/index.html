<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yomitan多功能词典查询</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px 0;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        header p {
            font-size: 1.1rem;
            max-width: 700px;
            margin: 0 auto;
            opacity: 0.9;
        }
        
        .mode-selector {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        
        .mode-selector h2 {
            margin-bottom: 15px;
            color: #2575fc;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .mode-options {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .mode-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .mode-option:hover {
            background: #e9ecef;
        }
        
        .mode-option.active {
            background: #e7f1ff;
            border-color: #2575fc;
            color: #2575fc;
        }
        
        .mode-option input {
            margin: 0;
        }
        
        .search-container {
            display: flex;
            margin-bottom: 30px;
            gap: 15px;
        }
        
        .search-box {
            flex: 1;
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 15px 20px 15px 50px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        
        .search-box input:focus {
            outline: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .search-box i {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        
        .search-options {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .option-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .option-group label {
            font-weight: 500;
        }
        
        .option-group select, .option-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        
        .results-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1024px) {
            .results-container {
                grid-template-columns: 1fr;
            }
        }
        
        .result-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .result-section.hidden {
            display: none;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .section-header h3 {
            color: #2575fc;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-content {
            flex: 1;
            overflow-y: auto;
        }
        
        .web-content-frame {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .web-content-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
            text-align: center;
            padding: 20px;
        }
        
        .web-content-placeholder i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .term-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .term-item {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .term-item:hover {
            border-color: #2575fc;
            box-shadow: 0 2px 8px rgba(37, 117, 252, 0.1);
        }
        
        .term-heading {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .term-expression {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2575fc;
        }
        
        .term-reading {
            color: #6c757d;
            font-style: italic;
        }
        
        .term-pos {
            background: #e9ecef;
            color: #495057;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .term-definitions {
            margin-top: 10px;
        }
        
        .definition-list {
            padding-left: 20px;
        }
        
        .definition-item {
            margin-bottom: 5px;
        }
        
        .api-results {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .api-item {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .api-source {
            font-weight: bold;
            color: #495057;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .api-content {
            color: #333;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
            background: #f8d7da;
            border-radius: 8px;
        }
        
        .btn {
            padding: 12px 24px;
            background: #2575fc;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #1a68e8;
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .search-container {
                flex-direction: column;
            }
            
            .search-options {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .term-heading {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .mode-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-search"></i> Yomitan多功能词典查询</h1>
            <p>集成词典查询、网页内容搜索和API查询的一站式解决方案</p>
        </header>
        
        <div class="mode-selector">
            <h2><i class="fas fa-cog"></i> 搜索模式选择</h2>
            <div class="mode-options">
                <label class="mode-option" id="modeDictionaryOption">
                    <input type="checkbox" id="modeDictionary" checked>
                    <i class="fas fa-book"></i>
                    <span>Yomitan词典</span>
                </label>
                <label class="mode-option" id="modeWebOption">
                    <input type="checkbox" id="modeWeb">
                    <i class="fas fa-globe"></i>
                    <span>网页内容</span>
                </label>
                <label class="mode-option" id="modeAPIOption">
                    <input type="checkbox" id="modeAPI">
                    <i class="fas fa-code"></i>
                    <span>API查询</span>
                </label>
            </div>
        </div>
        
        <div class="search-container">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="输入要查询的内容...">
            </div>
            <button class="btn" id="searchBtn">搜索</button>
        </div>
        
        <div class="search-options">
            <div class="option-group">
                <label for="searchMode">搜索模式:</label>
                <select id="searchMode">
                    <option value="exact">精确匹配</option>
                    <option value="prefix">前缀匹配</option>
                    <option value="suffix">后缀匹配</option>
                    <option value="contains">包含匹配</option>
                </select>
            </div>
            <div class="option-group">
                <label for="maxResults">最大结果数:</label>
                <input type="number" id="maxResults" value="50" min="10" max="200">
            </div>
            <div class="option-group">
                <input type="checkbox" id="caseSensitive">
                <label for="caseSensitive">区分大小写</label>
            </div>
        </div>
        
        <div class="results-container">
            <!-- Yomitan词典结果区域 -->
            <div class="result-section" id="dictionarySection">
                <div class="section-header">
                    <h3><i class="fas fa-book"></i> Yomitan词典</h3>
                    <div class="results-count" id="dictionaryResultsCount">等待搜索...</div>
                </div>
                <div class="section-content" id="dictionaryResultsContent">
                    <div class="no-results">
                        <i class="fas fa-search"></i> 输入搜索词开始查询词典
                    </div>
                </div>
            </div>
            
            <!-- 网页内容结果区域 -->
            <div class="result-section hidden" id="webSection">
                <div class="section-header">
                    <h3><i class="fas fa-globe"></i> 网页内容</h3>
                    <div class="results-count" id="webResultsCount">等待搜索...</div>
                </div>
                <div class="section-content" id="webResultsContent">
                    <div class="web-content-placeholder">
                        <i class="fas fa-browser"></i>
                        <h4>网页内容区域</h4>
                        <p>此区域用于显示通过油猴脚本获取的网页内容</p>
                        <p>请安装相应的油猴脚本并开始搜索</p>
                    </div>
                </div>
            </div>
            
            <!-- API查询结果区域 -->
            <div class="result-section hidden" id="apiSection">
                <div class="section-header">
                    <h3><i class="fas fa-code"></i> API查询</h3>
                    <div class="results-count" id="apiResultsCount">等待搜索...</div>
                </div>
                <div class="section-content" id="apiResultsContent">
                    <div class="no-results">
                        <i class="fas fa-search"></i> 输入搜索词开始API查询
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Yomitan多功能词典查询页面 &copy; 2023 | 支持词典查询、网页内容搜索和API查询</p>
        </footer>
    </div>

    <script>
        // 全局变量存储词典数据
        let dictionaryData = {
            index: null,
            tagBanks: [],
            termBanks: []
        };

        // 当前激活的搜索模式
        let activeModes = {
            dictionary: true,
            web: false,
            api: false
        };

        // 初始化模式选择
        function initModeSelector() {
            const modeDictionary = document.getElementById('modeDictionary');
            const modeWeb = document.getElementById('modeWeb');
            const modeAPI = document.getElementById('modeAPI');
            
            const modeDictionaryOption = document.getElementById('modeDictionaryOption');
            const modeWebOption = document.getElementById('modeWebOption');
            const modeAPIOption = document.getElementById('modeAPIOption');
            
            // 设置初始状态
            updateModeUI();
            
            // 添加事件监听器
            modeDictionary.addEventListener('change', function() {
                activeModes.dictionary = this.checked;
                updateModeUI();
                updateResultsVisibility();
            });
            
            modeWeb.addEventListener('change', function() {
                activeModes.web = this.checked;
                updateModeUI();
                updateResultsVisibility();
            });
            
            modeAPI.addEventListener('change', function() {
                activeModes.api = this.checked;
                updateModeUI();
                updateResultsVisibility();
            });
        }
        
        // 更新模式选择UI
        function updateModeUI() {
            const modeDictionaryOption = document.getElementById('modeDictionaryOption');
            const modeWebOption = document.getElementById('modeWebOption');
            const modeAPIOption = document.getElementById('modeAPIOption');
            
            if (activeModes.dictionary) {
                modeDictionaryOption.classList.add('active');
            } else {
                modeDictionaryOption.classList.remove('active');
            }
            
            if (activeModes.web) {
                modeWebOption.classList.add('active');
            } else {
                modeWebOption.classList.remove('active');
            }
            
            if (activeModes.api) {
                modeAPIOption.classList.add('active');
            } else {
                modeAPIOption.classList.remove('active');
            }
        }
        
        // 更新结果区域可见性
        function updateResultsVisibility() {
            const dictionarySection = document.getElementById('dictionarySection');
            const webSection = document.getElementById('webSection');
            const apiSection = document.getElementById('apiSection');
            
            if (activeModes.dictionary) {
                dictionarySection.classList.remove('hidden');
            } else {
                dictionarySection.classList.add('hidden');
            }
            
            if (activeModes.web) {
                webSection.classList.remove('hidden');
            } else {
                webSection.classList.add('hidden');
            }
            
            if (activeModes.api) {
                apiSection.classList.remove('hidden');
            } else {
                apiSection.classList.add('hidden');
            }
            
            // 更新网格布局
            const resultsContainer = document.querySelector('.results-container');
            const activeSections = [activeModes.dictionary, activeModes.web, activeModes.api].filter(Boolean).length;
            
            if (activeSections === 1) {
                resultsContainer.style.gridTemplateColumns = '1fr';
            } else if (activeSections === 2) {
                resultsContainer.style.gridTemplateColumns = '1fr 1fr';
            } else {
                resultsContainer.style.gridTemplateColumns = '1fr 1fr';
            }
        }

        // 加载词典数据
        async function loadDictionaryData() {
            try {
                console.log('开始加载词典数据...');
                
                // 显示加载状态
                document.getElementById('dictionaryResultsContent').innerHTML = `
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> 正在加载词典数据...
                    </div>
                `;

                // 加载index.json
                const indexResponse = await fetch('./dict/index.json');
                if (!indexResponse.ok) {
                    throw new Error('无法加载index.json文件');
                }
                dictionaryData.index = await indexResponse.json();
                
                // 尝试加载tag_bank文件
                try {
                    const tagBankResponse = await fetch('./dict/tag_bank_1.json');
                    if (tagBankResponse.ok) {
                        dictionaryData.tagBanks = await tagBankResponse.json();
                    }
                } catch (error) {
                    console.warn('无法加载tag_bank文件:', error);
                }

                // 加载所有term_bank文件
                let bankIndex = 1;
                let loadedBanks = 0;
                
                while (true) {
                    try {
                        const termBankResponse = await fetch(`./dict/term_bank_${bankIndex}.json`);
                        if (!termBankResponse.ok) {
                            break;
                        }
                        const termBankData = await termBankResponse.json();
                        dictionaryData.termBanks = dictionaryData.termBanks.concat(termBankData);
                        bankIndex++;
                        loadedBanks++;
                    } catch (error) {
                        break;
                    }
                }

                if (dictionaryData.termBanks.length === 0) {
                    throw new Error('未找到任何term_bank文件');
                }

                console.log(`成功加载词典: ${dictionaryData.index.title}`);
                console.log(`加载了 ${loadedBanks} 个term_bank文件，共 ${dictionaryData.termBanks.length} 个术语`);

                // 更新词典信息
                document.getElementById('dictionaryResultsContent').innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i> 词典加载完成，请输入搜索词
                    </div>
                `;

            } catch (error) {
                console.error('加载词典数据时出错:', error);
                document.getElementById('dictionaryResultsContent').innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-triangle"></i> 加载词典数据失败: ${error.message}
                    </div>
                `;
            }
        }

        // 执行搜索
        function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            const searchMode = document.getElementById('searchMode').value;
            const maxResults = parseInt(document.getElementById('maxResults').value);
            const caseSensitive = document.getElementById('caseSensitive').checked;
            
            if (!query) {
                alert('请输入搜索词');
                return;
            }
            
            // 执行词典搜索
            if (activeModes.dictionary) {
                performDictionarySearch(query, searchMode, maxResults, caseSensitive);
            }
            
            // 执行网页内容搜索
            if (activeModes.web) {
                performWebSearch(query);
            }
            
            // 执行API搜索
            if (activeModes.api) {
                performAPISearch(query);
            }
        }

        // 执行词典搜索
        function performDictionarySearch(query, searchMode, maxResults, caseSensitive) {
            document.getElementById('dictionaryResultsContent').innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> 正在搜索词典...
                </div>
            `;
            
            setTimeout(() => {
                let results = [];
                const searchQuery = caseSensitive ? query : query.toLowerCase();
                
                for (const term of dictionaryData.termBanks) {
                    if (!Array.isArray(term) || term.length < 2) continue;
                    
                    const expression = caseSensitive ? term[0] : (term[0] || '').toLowerCase();
                    const reading = caseSensitive ? term[1] : (term[1] || '').toLowerCase();
                    
                    let match = false;
                    
                    switch (searchMode) {
                        case 'exact':
                            match = expression === searchQuery || reading === searchQuery;
                            break;
                        case 'prefix':
                            match = expression.startsWith(searchQuery) || reading.startsWith(searchQuery);
                            break;
                        case 'suffix':
                            match = expression.endsWith(searchQuery) || reading.endsWith(searchQuery);
                            break;
                        case 'contains':
                            match = expression.includes(searchQuery) || reading.includes(searchQuery);
                            break;
                    }
                    
                    if (match) {
                        results.push(term);
                        if (results.length >= maxResults) {
                            break;
                        }
                    }
                }
                
                displayDictionaryResults(results, query);
            }, 100);
        }

        // 显示词典搜索结果
        function displayDictionaryResults(results, query) {
            const resultsContent = document.getElementById('dictionaryResultsContent');
            const resultsCount = document.getElementById('dictionaryResultsCount');
            
            if (results.length === 0) {
                resultsContent.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i> 没有找到匹配"${query}"的术语
                    </div>
                `;
                resultsCount.textContent = '未找到结果';
                return;
            }
            
            resultsCount.textContent = `找到 ${results.length} 个结果`;
            
            let html = '<div class="term-list">';
            
            for (const term of results) {
                if (!Array.isArray(term) || term.length < 6) continue;
                
                const expression = term[0] || '';
                const reading = term[1] || '';
                const definitionTags = term[2] || '';
                const score = term[4] || 0;
                const glossary = Array.isArray(term[5]) ? term[5] : [term[5] || ''];
                
                html += `
                    <div class="term-item">
                        <div class="term-heading">
                            <div>
                                <div class="term-expression">${escapeHtml(expression)}</div>
                                ${reading && reading !== expression ? `<div class="term-reading">${escapeHtml(reading)}</div>` : ''}
                            </div>
                            ${definitionTags ? `<span class="term-pos">${escapeHtml(definitionTags)}</span>` : ''}
                        </div>
                        <div class="term-definitions">
                            <ul class="definition-list">
                                ${glossary.map(def => `<li class="definition-item">${escapeHtml(def)}</li>`).join('')}
                            </ul>
                        </div>
                        ${score ? `<div style="margin-top: 10px; font-size: 0.8rem; color: #6c757d;">评分: ${score}</div>` : ''}
                    </div>
                `;
            }
            
            html += '</div>';
            resultsContent.innerHTML = html;
        }

        // 执行网页内容搜索
        function performWebSearch(query) {
            document.getElementById('webResultsContent').innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> 正在获取网页内容...
                </div>
            `;
            
            document.getElementById('webResultsCount').textContent = '获取中...';
            
            // 这里预留油猴脚本接口
            // 油猴脚本可以通过以下方式将内容注入到这个区域：
            // 1. 监听搜索事件
            // 2. 获取网页内容
            // 3. 调用 window.injectWebContent(htmlContent) 函数
            
            // 模拟延迟，等待油猴脚本响应
            setTimeout(() => {
                // 如果没有油猴脚本响应，显示提示信息
                if (document.getElementById('webResultsContent').innerHTML.includes('正在获取网页内容')) {
                    document.getElementById('webResultsContent').innerHTML = `
                        <div class="web-content-placeholder">
                            <i class="fas fa-browser"></i>
                            <h4>等待油猴脚本响应</h4>
                            <p>此区域需要油猴脚本提供网页内容</p>
                            <p>请确保已安装相应的油猴脚本</p>
                            <p>搜索词: "${query}"</p>
                        </div>
                    `;
                    document.getElementById('webResultsCount').textContent = '等待脚本';
                }
            }, 2000);
        }

        // 执行API搜索
        function performAPISearch(query) {
            document.getElementById('apiResultsContent').innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> 正在查询API...
                </div>
            `;
            
            document.getElementById('apiResultsCount').textContent = '查询中...';
            
            // 模拟API查询结果
            setTimeout(() => {
                const results = [
                    {
                        source: '词典API',
                        content: `找到关于"${query}"的5个相关结果`
                    },
                    {
                        source: '翻译API',
                        content: `"${query}"的翻译结果: 示例翻译内容`
                    },
                    {
                        source: '例句API',
                        content: `"${query}"的例句: 这是一个示例句子。`
                    }
                ];
                
                displayAPIResults(results, query);
            }, 1500);
        }

        // 显示API搜索结果
        function displayAPIResults(results, query) {
            const resultsContent = document.getElementById('apiResultsContent');
            const resultsCount = document.getElementById('apiResultsCount');
            
            if (results.length === 0) {
                resultsContent.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i> 没有找到匹配"${query}"的API结果
                    </div>
                `;
                resultsCount.textContent = '未找到结果';
                return;
            }
            
            resultsCount.textContent = `找到 ${results.length} 个API结果`;
            
            let html = '<div class="api-results">';
            
            for (const result of results) {
                html += `
                    <div class="api-item">
                        <div class="api-source">
                            <i class="fas fa-database"></i>
                            ${escapeHtml(result.source)}
                        </div>
                        <div class="api-content">
                            ${escapeHtml(result.content)}
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            resultsContent.innerHTML = html;
        }

        // HTML转义函数
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 全局函数，供油猴脚本调用
        window.injectWebContent = function(htmlContent) {
            document.getElementById('webResultsContent').innerHTML = htmlContent;
            document.getElementById('webResultsCount').textContent = '内容已加载';
        };

        // 设置事件监听器
        function setupEventListeners() {
            document.getElementById('searchBtn').addEventListener('click', performSearch);
            document.getElementById('searchInput').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        }

        // 初始化页面
        function init() {
            console.log('开始初始化页面...');
            initModeSelector();
            setupEventListeners();
            loadDictionaryData().then(() => {
                console.log('页面初始化完成');
            }).catch(error => {
                console.error('初始化失败:', error);
            });
        }

        // 启动初始化
        init();
    </script>
</body>
</html>